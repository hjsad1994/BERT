# IMPROVED Dual-Task ABSA Configuration
# Target: Detection F1 > 92%
# ========================================================================

paths:
  data_dir: "multi_label/data"
  train_file: "multi_label/data/train_multilabel_balanced.csv"  # Use balanced!
  validation_file: "multi_label/data/validation_multilabel.csv"
  test_file: "multi_label/data/test_multilabel.csv"
  output_dir: "multi_label/models/improved_focal"

model:
  name: "5CD-AI/visobert-14gb-corpus"
  num_aspects: 11
  num_sentiments: 3
  max_length: 256
  hidden_size: 512
  dropout: 0.3

training:
  per_device_train_batch_size: 32
  per_device_eval_batch_size: 64
  learning_rate: 2.0e-5
  weight_decay: 0.01
  warmup_ratio: 0.06
  num_train_epochs: 8  # More epochs
  
  # Optimizer
  optim: "adamw_torch"
  adam_beta1: 0.9
  adam_beta2: 0.999
  adam_epsilon: 1.0e-8
  max_grad_norm: 1.0
  
  # Mixed precision
  fp16: true
  
  # Evaluation
  evaluation_strategy: "epoch"
  save_strategy: "epoch"
  save_total_limit: 3
  load_best_model_at_end: true
  metric_for_best_model: "eval_detection_f1"  # Focus on detection!
  greater_is_better: true

reproducibility:
  training_seed: 42

# ========================================================================
# IMPROVED SETTINGS FOR >92% F1
# ========================================================================
multi_label:
  # ⚠️ KEY CHANGES FOR BETTER DETECTION
  
  # 1. HIGHER GAMMA for extreme imbalance
  detection_gamma: 3.5    # ← Was 2.0, now 3.5 for hard examples
  sentiment_gamma: 2.0    # Keep standard
  
  # 2. PRIORITIZE DETECTION (harder task)
  detection_weight: 0.65  # ← Was 0.3, now 0.65!
  sentiment_weight: 0.35  # ← Was 0.7, now 0.35
  
  # 3. AGGRESSIVE ALPHA for class imbalance
  # Manual weights: [negative_weight, positive_weight]
  detection_alpha: [0.2, 5.0]  # ← 25x weight for minority "present" class!
  sentiment_alpha: [1.0, 1.2, 0.8]  # Keep balanced
  
  # 4. USE BALANCED DATASET
  use_balanced_data: true
  balance_method: "aspect_wise"
  
  # 5. THRESHOLD OPTIMIZATION
  optimize_thresholds: true
  threshold_search_range: [0.25, 0.75]
  threshold_search_steps: 11
  
  # 6. AUXILIARY LOSSES (optional but helps)
  use_dice_loss: true
  dice_weight: 0.1
  use_asymmetric_loss: true
  asymmetric_weight: 0.1
  asymmetric_pos_weight: 5.0  # 5x penalty for false negatives

# ========================================================================
# TWO-STAGE TRAINING (Optional but recommended)
# ========================================================================
two_stage:
  enabled: true
  
  # Stage 1: Detection only
  stage1_epochs: 4
  stage1_detection_weight: 1.0
  stage1_sentiment_weight: 0.0
  stage1_lr: 3.0e-5  # Higher LR for detection
  
  # Stage 2: Joint training
  stage2_epochs: 4
  stage2_detection_weight: 0.6
  stage2_sentiment_weight: 0.4
  stage2_lr: 1.0e-5  # Lower LR for fine-tuning

# ========================================================================
# DATA AUGMENTATION
# ========================================================================
augmentation:
  enabled: true
  oversample_minority: true
  oversample_ratio: 0.5  # Target 1:2 ratio instead of 1:5
  
  # Synthetic augmentation for aspects
  synthetic_augmentation: true
  augmentation_templates:
    Battery: ["pin {quality}", "thời lượng pin {quality}", "battery {quality}"]
    Camera: ["camera {quality}", "chụp ảnh {quality}", "máy ảnh {quality}"]
    Performance: ["hiệu năng {quality}", "tốc độ {quality}", "lag {quality}"]
    Display: ["màn hình {quality}", "display {quality}", "độ phân giải {quality}"]
    
  quality_words:
    positive: ["tốt", "xuất sắc", "tuyệt vời", "ok", "ổn"]
    negative: ["tệ", "kém", "xấu", "chậm", "lag"]
    neutral: ["bình thường", "tạm được", "cũng được", "tàm tạm"]

# ========================================================================
# EXPECTED IMPROVEMENTS
# ========================================================================
# 
# With these changes:
# - Detection F1: 88-89% → 92-93% ✅ (+4 points)
# - Sentiment F1: 95-96% → 95-96% (maintained)
# 
# Key improvements:
# 1. Higher gamma (3.5) → Better handling of hard examples
# 2. Detection weight 0.65 → More gradient signal for harder task
# 3. Alpha [0.2, 5.0] → 25x weight for minority class
# 4. Auxiliary losses → Better gradient flow
# 5. Two-stage training → Task-specific optimization
# 6. Data augmentation → More balanced training
# ========================================================================
